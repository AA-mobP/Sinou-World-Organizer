// بيانات عالم الرواية
        let worldData = {
            "الخلفية الكونية والعالم": {
                "التغييرات الكونية الكبرى": [
                    "الحقبة الأولى: العالم كما نعرفه",
                    "الحقبة الثانية: الفوضى، حرب نووية، تشوهات كهرومغناطيسية",
                    "الحقبة الثالثة: شعاع من الطاقة المظلمة يضرب النظام الشمسي",
                    "الكيانات العليا تخلط طاقتها ببصمتها الذاتية",
                    "الطاقات الجديدة تؤثر في البنية الجينية وتخلق طفرات",
                    "تنتج مجتمعات جديدة، صراعات، طبقية، وتمييز عرقي/طاقي"
                ],
                "خصائص العالم": [
                    "العالم متغير (إما نسخة مغايرة من عالمنا أو عالم خيالي جديد)",
                    "هناك أبعاد فرعية/زنزانات تجذب الأفراد في سن معين",
                    "البشر يملكون قدرة فريدة على احتواء أنواع متعددة من الطاقات"
                ]
            },
            "نظام القوة": {
                "المسارات الأساسية": [
                    "مسار الدمى: دمية → جسد الدمية → محرك → صانع → سيد → قفص → مسرح → روح → طفيلي",
                    "مسار الأحلام: متجول → ناسج → صانع → سارق → حلم",
                    "مسار البطاقات: ساحر بطاقات، مستدعي",
                    "مسار المعدات: صانع الأسلحة والمعدات",
                    "المسارات الأخرى: الرسم، الخيال، سحر الكلام"
                ],
                "النظام العام": [
                    "كل المسارات تستمد طاقتها من الكيان الكوني الأعلى (مخطوم منذ العصور القديمة)",
                    "الطاقة موزعة عبر عدة أختام؛ استخدام الطاقة متاح من خلالها دون وعي بالحقيقة الأصلية",
                    "كل سحر في العالم له نفس المصدر العلوي"
                ],
                "المستويات": [
                    "تقدم تدريجي ضخم (الفرق 99/100 بين الفئات)",
                    "اختراق الحواجز يتطلب طقوس وتكاليف خاصة",
                    "المهارات قد تأتي من الدم، من البعد، أو من الجوهر"
                ],
                "نظام الجوهر": [
                    "يخرج من جسد المستيقظ بعد موته",
                    "يحمل خصلة من حمضه النووي",
                    "لا يتكرر بنفس الشكل، وكل مرة يتغير",
                    "يُستهلك وفق شروط صارمة: لا يمكن استهلاك أكثر من جوهر",
                    "يُصنع منه أدوات، أو يتحول إلى كنوز أو لعنات",
                    "الوحوش التي تتغذى عليه تتطور"
                ],
                "الاستيقاظ": [
                    "لا يمكن قبل سن 16–17، إلا باستثناءات نادرة",
                    "يتطلب طقسًا داخل البعد",
                    "عند النجاح، يُدمج دم الكيان في الجسد",
                    "نسبة فشل مرتفعة: موت، تشوه، مسخ",
                    "أبناء المستيقظين يملكون قدرة تكيف أفضل",
                    "بعض الأبناء يرثون قدرات فطرية"
                ]
            },
            "التنظيمات والجهات الكبرى": {
                "الكنائس": [
                    "كنيسة إله القدر (رمزها: فراشة وعنكبوت)",
                    "تسيطر على الأفراد من خلال طقوس وهياكل سلطوية",
                    "تستغل وحشًا تعتقد أنه في سبات، لكنه مستيقظ ويسمح لهم عمدًا باستخدام طاقته",
                    "يخطط لتحويل أجساد مستخدميه إلى طلاسم لتعويذة كونية ضد عدو قديم"
                ],
                "الحكومات": [
                    "تفرض نظام رخصة للمستيقظين",
                    "من يستخدم قدراته بدون رخصة يُعتبر مجرمًا",
                    "الهدف الظاهري: حماية الناس، الهدف الحقيقي: السيطرة الكاملة على المواهب"
                ],
                "الأسر الكبرى": [
                    "تحتكر الجواهر",
                    "تفرض قوانين زواج صارمة",
                    "تحافظ على نقاء السلالة",
                    "كل سلالة ذات دم قوي ترفض حمل طاقة معارضة"
                ]
            },
            "القوانين الكونية المعروفة": {
                "القيود الزمنية والعقلية": [
                    "لا قدرة على السفر عبر الزمن",
                    "لا قدرة على التنبؤ بالمستقبل بدقة مطلقة",
                    "يمكن السيطرة على العقول، لكن لا يمكن قراءة الأفكار أو الذكريات"
                ],
                "الموارد والطاقة": [
                    "المانا تنتجها الأشجار، وتوجد أراضٍ خضراء تتنازع عليها القوى",
                    "هناك حجارة خاصة تنتج مانا من نوع آخر"
                ]
            },
            "عناصر رمزية وسرية": {
                "الأدوات والمعرفة": [
                    "الكتاب/اللوح: موسوعة لعنات وكنوز ومهارات، أوراقه مبعثرة حول العالم",
                    "المعرفة المحرمة: محظورة من قبل الكنيسة. تشمل حقائق البعد الآخر، الفلسفة، مصدر السحر"
                ],
                "الأماكن المهمة": [
                    "دولة الشرق: تسمح بالمعرفة الحرة، بعكس الدول الأخرى",
                    "الدانجيون/البعد: يستخدم لاستيقاظ الأفراد، مليء بالمخاطر، البقاء فيه يفسد الروح"
                ]
            }
        };

        let currentEditPath = null;
        let currentEditType = null;

        // عرض المحتوى
        function renderContent() {
            const container = document.getElementById('worldContent');
            container.innerHTML = '';

            Object.keys(worldData).forEach(sectionKey => {
                const section = worldData[sectionKey];
                const sectionElement = createSectionElement(sectionKey, section);
                container.appendChild(sectionElement);
            });

            updateStats();
        }

        // إنشاء عنصر قسم
        function createSectionElement(sectionKey, section) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'mb-4';

            const headerId = `section-${sectionKey.replace(/\s+/g, '-')}`;
            const collapseId = `collapse-${sectionKey.replace(/\s+/g, '-')}`;

            sectionDiv.innerHTML = `
                    <div class="section-header" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                        <i class="fas fa-chevron-down toggle-icon"></i>
                        <h2>${sectionKey}</h2>
                        <button class="collapse-toggle" onclick="event.stopPropagation()">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="edit-button" onclick="event.stopPropagation(); editSection('${sectionKey}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-button" onclick="event.stopPropagation(); deleteSection('${sectionKey}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="collapse show" id="${collapseId}">
                        <div class="p-3">
                            ${createSubsectionsHTMLWithTables(sectionKey, section)}
                            <button class="add-button" onclick="addSubsection('${sectionKey}')">
                                <i class="fas fa-plus"></i> إضافة قسم فرعي
                            </button>
                        </div>
                    </div>
                `;

            return sectionDiv;
        }
        
        // إنشاء HTML للأقسام الفرعية
        function createSubsectionsHTML(sectionKey, section) {
            let html = '';

            Object.keys(section).forEach(subsectionKey => {
                const items = section[subsectionKey];
                const subsectionId = `subsection-${sectionKey.replace(/\s+/g, '-')}-${subsectionKey.replace(/\s+/g, '-')}`;

                html += `
                        <div class="subsection">
                            <div class="subsection-header" data-bs-toggle="collapse" data-bs-target="#${subsectionId}">
                                <h4>
                                    <i class="fas fa-chevron-down me-2"></i>
                                    ${subsectionKey}
                                </h4>
                                <button class="edit-button" onclick="event.stopPropagation(); editSubsection('${sectionKey}', '${subsectionKey}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-button" onclick="event.stopPropagation(); deleteSubsection('${sectionKey}', '${subsectionKey}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="collapse show" id="${subsectionId}">
                                <div class="subsection-content">
                                    ${createItemsHTML(sectionKey, subsectionKey, items)}
                                    <button class="add-button" onclick="addItem('${sectionKey}', '${subsectionKey}')">
                                        <i class="fas fa-plus"></i> إضافة عنصر
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
            });

            return html;
        }

        // إنشاء HTML للعناصر
        function createItemsHTML(sectionKey, subsectionKey, items) {
            let html = '';

            items.forEach((item, index) => {
                html += `
                        <div class="detail-item">
                            <span class="item-text">${item}</span>
                            <button class="edit-button" onclick="editItem('${sectionKey}', '${subsectionKey}', ${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-button" onclick="deleteItem('${sectionKey}', '${subsectionKey}', ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
            });

            return html;
        }

        // إضافة قسم جديد
        function addNewSection() {
            const sectionName = prompt('اسم القسم الجديد:');
            if (sectionName && !worldData[sectionName]) {
                worldData[sectionName] = {};
                renderContent();
                saveToStorage();
            }
        }

        // إضافة قسم فرعي
        function addSubsection(sectionKey) {
            const subsectionName = prompt('اسم القسم الفرعي الجديد:');
            if (subsectionName && !worldData[sectionKey][subsectionName]) {
                worldData[sectionKey][subsectionName] = [];
                renderContent();
                saveToStorage();
            }
        }

        // إضافة عنصر
        function addItem(sectionKey, subsectionKey) {
            const itemText = prompt('نص العنصر الجديد:');
            if (itemText) {
                worldData[sectionKey][subsectionKey].push(itemText);
                renderContent();
                saveToStorage();
            }
        }

        // تعديل قسم
        function editSection(sectionKey) {
            const newName = prompt('الاسم الجديد للقسم:', sectionKey);
            if (newName && newName !== sectionKey) {
                worldData[newName] = worldData[sectionKey];
                delete worldData[sectionKey];
                renderContent();
                saveToStorage();
            }
        }

        // تعديل قسم فرعي
        function editSubsection(sectionKey, subsectionKey) {
            const newName = prompt('الاسم الجديد للقسم الفرعي:', subsectionKey);
            if (newName && newName !== subsectionKey) {
                worldData[sectionKey][newName] = worldData[sectionKey][subsectionKey];
                delete worldData[sectionKey][subsectionKey];
                renderContent();
                saveToStorage();
            }
        }

        // تعديل عنصر
        function editItem(sectionKey, subsectionKey, itemIndex) {
            currentEditPath = [sectionKey, subsectionKey, itemIndex];
            currentEditType = 'item';

            const currentText = worldData[sectionKey][subsectionKey][itemIndex];
            document.getElementById('editText').value = currentText;
            document.getElementById('modalTitle').textContent = 'تعديل العنصر';

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // حفظ التعديل
        function saveEdit() {
            const newText = document.getElementById('editText').value;

            if (currentEditType === 'item' && currentEditPath) {
                const [sectionKey, subsectionKey, itemIndex] = currentEditPath;
                worldData[sectionKey][subsectionKey][itemIndex] = newText;
                renderContent();
                saveToStorage();
            }

            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        // حذف قسم
        function deleteSection(sectionKey) {
            if (confirm(`هل أنت متأكد من حذف القسم "${sectionKey}"؟`)) {
                delete worldData[sectionKey];
                renderContent();
                saveToStorage();
            }
        }

        // حذف قسم فرعي
        function deleteSubsection(sectionKey, subsectionKey) {
            if (confirm(`هل أنت متأكد من حذف القسم الفرعي "${subsectionKey}"؟`)) {
                delete worldData[sectionKey][subsectionKey];
                renderContent();
                saveToStorage();
            }
        }

        // حذف عنصر
        function deleteItem(sectionKey, subsectionKey, itemIndex) {
            if (confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
                worldData[sectionKey][subsectionKey].splice(itemIndex, 1);
                renderContent();
                saveToStorage();
            }
        }

        // البحث في المحتوى
        function searchContent(query) {
            const elements = document.querySelectorAll('.item-text, .subsection-header h4, .section-header h2');

            elements.forEach(element => {
                const text = element.textContent.toLowerCase();
                const searchQuery = query.toLowerCase();

                // إزالة التمييز السابق
                element.innerHTML = element.innerHTML.replace(/<mark class="highlight">(.*?)<\/mark>/gi, '$1');

                if (searchQuery && text.includes(searchQuery)) {
                    // تمييز النص المطابق
                    const regex = new RegExp(`(${searchQuery})`, 'gi');
                    element.innerHTML = element.innerHTML.replace(regex, '<mark class="highlight">$1</mark>');

                    // إظهار القسم المحتوي على النتيجة
                    const section = element.closest('.collapse');
                    if (section && !section.classList.contains('show')) {
                        bootstrap.Collapse.getOrCreateInstance(section).show();
                    }
                }
            });
        }

        // تحديث الإحصائيات
        function updateStats() {
            const totalSections = Object.keys(worldData).length;
            let totalSubsections = 0;
            let totalItems = 0;

            Object.values(worldData).forEach(section => {
                totalSubsections += Object.keys(section).length;
                Object.values(section).forEach(items => {
                    totalItems += items.length;
                });
            });

            document.getElementById('totalSections').textContent = totalSections;
            document.getElementById('totalSubsections').textContent = totalSubsections;
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('lastModified').textContent = new Date().toLocaleDateString('ar-EG');
        }

        // حفظ البيانات محليًا
        function saveToStorage() {
            try {
                const dataToSave = {
                    worldData: worldData,
                    lastModified: new Date().toISOString()
                };
                localStorage.setItem('novelWorldData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
            }
        }

        // تحميل البيانات المحفوظة
        // 1. تحديث دالة loadFromStorage لإعادة تعيين tableCounter
        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem('novelWorldData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    worldData = parsedData.worldData || worldData;

                    // إعادة تعيين tableCounter بناءً على الجداول الموجودة
                    if (worldData['الجداول']) {
                        const tableKeys = Object.keys(worldData['الجداول']);
                        const maxCounter = Math.max(
                            0,
                            ...tableKeys
                                .filter(key => key.startsWith('table_'))
                                .map(key => parseInt(key.split('_')[1]) || 0)
                        );
                        tableCounter = maxCounter;
                    }
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
            }
        }

        // تصدير البيانات
        function exportData() {
            try {
                const dataToExport = {
                    worldData: worldData,
                    exportDate: new Date().toISOString(),
                    version: "1.0"
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `novel-world-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                URL.revokeObjectURL(link.href);
            } catch (error) {
                alert('خطأ في تصدير البيانات: ' + error.message);
            }
        }

        // استيراد البيانات
        function importData() {
            document.getElementById('importFile').click();
        }

        // معالجة ملف الاستيراد
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (importedData.worldData) {
                        if (confirm('هل أنت متأكد من استيراد البيانات الجديدة؟ سيتم استبدال البيانات الحالية.')) {
                            worldData = importedData.worldData;
                            renderContent();
                            saveToStorage();
                            alert('تم استيراد البيانات بنجاح!');
                        }
                    } else {
                        alert('ملف غير صالح!');
                    }
                } catch (error) {
                    alert('خطأ في قراءة الملف: ' + error.message);
                }
            };

            reader.readAsText(file);
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function () {
            loadFromStorage();
            renderContent();

            // ربط وظيفة البحث
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function () {
                searchContent(this.value);
            });

            // ربط معالج استيراد الملفات
            document.getElementById('importFile').addEventListener('change', handleImportFile);

            // معالجة أيقونات التبديل
            document.addEventListener('click', function (e) {
                if (e.target.closest('.section-header')) {
                    const header = e.target.closest('.section-header');
                    const icon = header.querySelector('.toggle-icon');

                    setTimeout(() => {
                        const target = document.querySelector(header.getAttribute('data-bs-target'));
                        if (target && target.classList.contains('show')) {
                            header.classList.remove('collapsed');
                        } else {
                            header.classList.add('collapsed');
                        }
                    }, 100);
                }
            });

            // إعداد tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // حفظ تلقائي كل 30 ثانية
            setInterval(saveToStorage, 30000);
        });

        // معالجة اختصارات لوحة المفاتيح
        document.addEventListener('keydown', function (e) {
            // Ctrl + S للحفظ
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToStorage();
                alert('تم حفظ البيانات!');
            }

            // Ctrl + E للتصدير
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportData();
            }

            // Ctrl + F للبحث
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });

        // وظائف مساعدة إضافية

        // نسخ قسم
        function duplicateSection(sectionKey) {
            const newSectionKey = prompt('اسم القسم المنسوخ:', sectionKey + ' (نسخة)');
            if (newSectionKey && !worldData[newSectionKey]) {
                worldData[newSectionKey] = JSON.parse(JSON.stringify(worldData[sectionKey]));
                renderContent();
                saveToStorage();
            }
        }

        // نسخ قسم فرعي
        function duplicateSubsection(sectionKey, subsectionKey) {
            const newSubsectionKey = prompt('اسم القسم الفرعي المنسوخ:', subsectionKey + ' (نسخة)');
            if (newSubsectionKey && !worldData[sectionKey][newSubsectionKey]) {
                worldData[sectionKey][newSubsectionKey] = [...worldData[sectionKey][subsectionKey]];
                renderContent();
                saveToStorage();
            }
        }

        // ترتيب الأقسام أبجديًا
        function sortSections() {
            const sortedData = {};
            Object.keys(worldData).sort().forEach(key => {
                sortedData[key] = worldData[key];
            });
            worldData = sortedData;
            renderContent();
            saveToStorage();
        }

        // إعادة تعيين البيانات
        function resetData() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع البيانات؟ لن يمكن التراجع عن هذا الإجراء!')) {
                if (confirm('تأكيد أخير - سيتم حذف جميع البيانات نهائيًا!')) {
                    worldData = {
                        "قسم تجريبي": {
                            "قسم فرعي تجريبي": [
                                "عنصر تجريبي"
                            ]
                        }
                    };
                    renderContent();
                    saveToStorage();
                }
            }
        }

        // طباعة المحتوى
        function printContent() {
            const printWindow = window.open('', '_blank');
            const printContent = document.getElementById('worldContent').cloneNode(true);

            // إزالة الأزرار من المحتوى المطبوع
            printContent.querySelectorAll('button').forEach(btn => btn.remove());

            printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>عالم الرواية - نسخة للطباعة</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .section-header { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; }
                            .subsection { margin: 15px 0; padding: 10px; border: 1px solid #ddd; }
                            .detail-item { margin: 8px 0; padding: 8px; background: #f9f9f9; }
                            h1, h2, h3, h4 { color: #333; }
                            .collapse { display: block !important; }
                        </style>
                    </head>
                    <body>
                        <h1>عالم الرواية - الوثيقة المرجعية</h1>
                        ${printContent.innerHTML}
                    </body>
                    </html>
                `);

            printWindow.document.close();
            printWindow.print();
        }

        // متغيرات الجداول
        let currentTableId = null;
        let tableCounter = 0;

        // إضافة جدول جديد
        // 5. تحديث addNewTable لضمان وجود قسم الجداول
        function addNewTable() {
            ensureTablesSection(); // التأكد من وجود قسم الجداول

            currentTableId = null;
            document.getElementById('tableTitle').value = '';
            document.getElementById('tableColumns').value = 5;
            document.getElementById('tableRows').value = 3;
            document.getElementById('columnHeaders').value = 'الرتبة, التسمية, الخصائص, الاعداد, الارتقاء';
            document.getElementById('tableModalTitle').textContent = 'إنشاء جدول جديد';

            const modalElement = document.getElementById('tableModal');
            if (modalElement) {
                new bootstrap.Modal(modalElement).show();
            } else {
                alert('لم يتم العثور على نافذة إنشاء الجدول!');
            }
        }

        // إنشاء الجدول
        // 2. تحديث دالة createTable لضمان عدم تضارب المفاتيح
        function createTable() {
            const title = document.getElementById('tableTitle').value.trim();
            const columns = parseInt(document.getElementById('tableColumns').value);
            const rows = parseInt(document.getElementById('tableRows').value);
            const headers = document.getElementById('columnHeaders').value.split(',').map(h => h.trim());

            if (!title) {
                alert('يرجى إدخال عنوان الجدول');
                return;
            }

            if (headers.length !== columns) {
                alert(`عدد عناوين الأعمدة (${headers.length}) لا يتطابق مع عدد الأعمدة المحدد (${columns})`);
                return;
            }

            // إنشاء بيانات الجدول
            const tableData = {
                title: title,
                headers: headers,
                rows: []
            };

            // إنشاء الصفوف الفارغة
            for (let i = 0; i < rows; i++) {
                const row = {};
                headers.forEach(header => {
                    row[header] = '';
                });
                tableData.rows.push(row);
            }

            // إضافة الجدول إلى البيانات
            if (!worldData['الجداول']) {
                worldData['الجداول'] = {};
            }

            // التأكد من عدم تضارب المفاتيح
            let tableKey;
            if (currentTableId) {
                tableKey = currentTableId;
            } else {
                do {
                    tableKey = `table_${++tableCounter}`;
                } while (worldData['الجداول'][tableKey]);
            }

            worldData['الجداول'][tableKey] = tableData;

            renderContent();
            saveToStorage();
            bootstrap.Modal.getInstance(document.getElementById('tableModal')).hide();
        }

        // عرض الجداول في المحتوى
        function renderTables() {
            if (!worldData['الجداول']) return '';

            let html = '';
            Object.keys(worldData['الجداول']).forEach(tableKey => {
                const table = worldData['الجداول'][tableKey];
                html += createTableHTML(tableKey, table);
            });

            return html;
        }

        // إنشاء HTML للجدول
        function createTableHTML(tableKey, tableData) {
            const tableId = `table-${tableKey}`;

            let html = `
        <div class="table-container" id="${tableId}">
            <div class="table-header">
                <h4 class="table-title">${tableData.title}</h4>
                <div class="table-actions">
                    <button class="table-button" onclick="editTableTitle('${tableKey}')">
                        <i class="fas fa-edit"></i> تعديل العنوان
                    </button>
                    <button class="table-button success" onclick="addTableRow('${tableKey}')">
                        <i class="fas fa-plus"></i> إضافة صف
                    </button>
                    <button class="table-button" onclick="addTableColumn('${tableKey}')">
                        <i class="fas fa-columns"></i> إضافة عمود
                    </button>
                    <button class="table-button danger" onclick="deleteTable('${tableKey}')">
                        <i class="fas fa-trash"></i> حذف الجدول
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
    `;

            // إضافة عناوين الأعمدة
            tableData.headers.forEach((header, index) => {
                html += `
            <th class="column-header">
                ${header}
                <div class="column-actions">
                    <button class="column-btn edit" onclick="editColumnHeader('${tableKey}', ${index})" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="column-btn" onclick="deleteTableColumn('${tableKey}', ${index})" title="حذف">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </th>
        `;
            });

            html += `
                            <th style="width: 80px;">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

            // إضافة صفوف البيانات
            tableData.rows.forEach((row, rowIndex) => {
                html += `<tr>`;
                html += `<td style="text-align: center; font-weight: bold; background: #e9ecef;">${rowIndex + 1}</td>`;

                tableData.headers.forEach(header => {
                    html += `
                <td>
                    <textarea 
                        onchange="updateTableCell('${tableKey}', ${rowIndex}, '${header}', this.value)"
                        placeholder="اكتب هنا..."
                    >${row[header] || ''}</textarea>
                </td>
            `;
                });

                html += `
            <td>
                <div class="row-actions">
                    <button class="row-btn" onclick="duplicateTableRow('${tableKey}', ${rowIndex})" title="نسخ">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="row-btn delete" onclick="deleteTableRow('${tableKey}', ${rowIndex})" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>`;
            });

            html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;

            return html;
        }

        // تحديث خلية في الجدول
        function updateTableCell(tableKey, rowIndex, header, value) {
            if (worldData['الجداول'] && worldData['الجداول'][tableKey]) {
                worldData['الجداول'][tableKey].rows[rowIndex][header] = value;
                saveToStorage();
            }
        }

        // إضافة صف جديد
        function addTableRow(tableKey) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            const table = worldData['الجداول'][tableKey];
            const newRow = {};
            table.headers.forEach(header => {
                newRow[header] = '';
            });

            table.rows.push(newRow);
            renderContent();
            saveToStorage();
        }

        // حذف صف
        function deleteTableRow(tableKey, rowIndex) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            if (confirm('هل أنت متأكد من حذف هذا الصف؟')) {
                worldData['الجداول'][tableKey].rows.splice(rowIndex, 1);
                renderContent();
                saveToStorage();
            }
        }

        // نسخ صف
        function duplicateTableRow(tableKey, rowIndex) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            const table = worldData['الجداول'][tableKey];
            const rowToCopy = { ...table.rows[rowIndex] };
            table.rows.splice(rowIndex + 1, 0, rowToCopy);
            renderContent();
            saveToStorage();
        }

        // إضافة عمود جديد
        function addTableColumn(tableKey) {
            const columnName = prompt('اسم العمود الجديد:');
            if (!columnName || !worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            const table = worldData['الجداول'][tableKey];
            table.headers.push(columnName);

            // إضافة العمود الجديد لكل الصفوف
            table.rows.forEach(row => {
                row[columnName] = '';
            });

            renderContent();
            saveToStorage();
        }

        // حذف عمود
        function deleteTableColumn(tableKey, columnIndex) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            const table = worldData['الجداول'][tableKey];
            if (table.headers.length <= 1) {
                alert('لا يمكن حذف آخر عمود في الجدول');
                return;
            }

            if (confirm('هل أنت متأكد من حذف هذا العمود؟')) {
                const headerToDelete = table.headers[columnIndex];
                table.headers.splice(columnIndex, 1);

                // حذف العمود من كل الصفوف
                table.rows.forEach(row => {
                    delete row[headerToDelete];
                });

                renderContent();
                saveToStorage();
            }
        }

        // تعديل عنوان العمود
        function editColumnHeader(tableKey, columnIndex) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            const table = worldData['الجداول'][tableKey];
            const oldHeader = table.headers[columnIndex];
            const newHeader = prompt('العنوان الجديد للعمود:', oldHeader);

            if (newHeader && newHeader !== oldHeader) {
                table.headers[columnIndex] = newHeader;

                // تحديث العنوان في كل الصفوف
                table.rows.forEach(row => {
                    row[newHeader] = row[oldHeader];
                    delete row[oldHeader];
                });

                renderContent();
                saveToStorage();
            }
        }

        // تعديل عنوان الجدول
        function editTableTitle(tableKey) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            const table = worldData['الجداول'][tableKey];
            const newTitle = prompt('العنوان الجديد للجدول:', table.title);

            if (newTitle && newTitle !== table.title) {
                table.title = newTitle;
                renderContent();
                saveToStorage();
            }
        }

        // حذف جدول
        function deleteTable(tableKey) {
            if (!worldData['الجداول'] || !worldData['الجداول'][tableKey]) return;

            if (confirm(`هل أنت متأكد من حذف الجدول "${worldData['الجداول'][tableKey].title}"؟`)) {
                delete worldData['الجداول'][tableKey];
                renderContent();
                saveToStorage();
            }
        }

        // تعديل دالة createSubsectionsHTML لتشمل الجداول
        // 3. حذف دالة renderTables() غير المستخدمة وتحديث createSubsectionsHTMLWithTables
        function createSubsectionsHTMLWithTables(sectionKey, section) {
            let html = '';

            // إذا كان القسم هو "الجداول"، عرض الجداول
            if (sectionKey === 'الجداول') {
                if (Object.keys(section).length === 0) {
                    html += `
                <div class="text-center p-4">
                    <i class="fas fa-table fa-2x text-muted mb-3"></i>
                    <p class="text-muted">لا توجد جداول بعد. قم بإنشاء جدول جديد للبدء.</p>
                </div>
            `;
                } else {
                    Object.keys(section).forEach(tableKey => {
                        const table = section[tableKey];
                        html += createTableHTML(tableKey, table);
                    });
                }
                return html;
            }

            // وإلا عرض الأقسام العادية
            Object.keys(section).forEach(subsectionKey => {
                const items = section[subsectionKey];
                const subsectionId = `subsection-${sectionKey.replace(/\s+/g, '-')}-${subsectionKey.replace(/\s+/g, '-')}`;

                html += `
            <div class="subsection">
                <div class="subsection-header" data-bs-toggle="collapse" data-bs-target="#${subsectionId}">
                    <h4>
                        <i class="fas fa-chevron-down me-2"></i>
                        ${subsectionKey}
                    </h4>
                    <button class="edit-button" onclick="event.stopPropagation(); editSubsection('${sectionKey}', '${subsectionKey}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-button" onclick="event.stopPropagation(); deleteSubsection('${sectionKey}', '${subsectionKey}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="collapse show" id="${subsectionId}">
                    <div class="subsection-content">
                        ${createItemsHTML(sectionKey, subsectionKey, items)}
                        <button class="add-button" onclick="addItem('${sectionKey}', '${subsectionKey}')">
                            <i class="fas fa-plus"></i> إضافة عنصر
                        </button>
                    </div>
                </div>
            </div>
        `;
            });

            return html;
        }

        // 4. إضافة دالة مساعدة لإنشاء قسم الجداول تلقائياً عند الحاجة
        function ensureTablesSection() {
            if (!worldData['الجداول']) {
                worldData['الجداول'] = {};
                renderContent();
                saveToStorage();
            }
        }
